{% extends "base.html" %}
{% block title %}ç”¨æˆ·æ³¨å†Œ{% endblock %}

{% block content %}
<div class="auth-card">
    <div class="auth-header">
        <h2>åˆ›å»ºè´¦æˆ·</h2>
        <p class="text-muted">ç«‹å³åŠ å…¥æˆ‘ä»¬</p>
    </div>
    
    <form method="POST" id="registerForm">
        {{ form.hidden_tag() }}
        <div class="mb-3">
            {{ form.username.label(class="form-label") }}
            {{ form.username(class="form-control") }}
        </div>
        <div class="mb-3">
            {{ form.password.label(class="form-label") }}
            {{ form.password(class="form-control", id="password") }}
        </div>
        <div class="mb-3">
            {{ form.confirm_password.label(class="form-label") }}
            {{ form.confirm_password(class="form-control") }}
        </div>
        <input type="hidden" id="pk_sig" name="pk_sig">
        <input type="hidden" id="secret_key" name="secret_key">
        <input type="hidden" id="sk_enc" name="sk_enc">
        <input type="hidden" id="pk_enc" name="pk_enc">

        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary btn-lg">æ³¨å†Œ</button>
        </div>
        <div class="mt-3 text-center">
            <span class="text-muted">å·²æœ‰è´¦å·ï¼Ÿ</span>
            <a href="{{ url_for('login') }}" class="text-decoration-none">ç«‹å³ç™»å½•</a>
        </div>
    </form>
</div>



<script src="https://cdnjs.cloudflare.com/ajax/libs/elliptic/6.5.4/elliptic.min.js"></script>
<script>
const ec = new elliptic.ec('secp256k1');

async function deriveR(k, pw) {
    const encoder = new TextEncoder();
    const keyData = encoder.encode(k);
    const messageData = encoder.encode(pw);

    const cryptoKey = await window.crypto.subtle.importKey(
        "raw",
        keyData,
        { name: "HMAC", hash: "SHA-256" },
        false,
        ["sign"]
    );

    const signature = await window.crypto.subtle.sign(
        "HMAC",
        cryptoKey,
        messageData
    );

    return new Uint8Array(signature);
}

function toValidPrivateKey(rHex) {
    try {
        const key = ec.keyFromPrivate(rHex, 'hex');
        const bn = key.getPrivate();
        const n = ec.curve.n;
        return bn.toString(16).padStart(64, '0');
    } catch (e) {
        console.error('Invalid private key:', e);
        throw new Error('ç§é’¥ç”Ÿæˆå¤±è´¥');
    }
}

async function generateKeyPair(k, pw) {
    const r = await deriveR(k, pw);
    const rHex = Array.from(r).map(b => b.toString(16).padStart(2, '0')).join('');
    const privKey = toValidPrivateKey(rHex);
    const keyPair = ec.keyFromPrivate(privKey, 'hex');
    return {
        sk_sig: privKey,
        pk_sig: keyPair.getPublic('hex')
    };
}

document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    // ç”Ÿæˆéšæœºå¯†é’¥k
    const kArray = new Uint8Array(32);
    window.crypto.getRandomValues(kArray);
    const k = Array.from(kArray, b => b.toString(16).padStart(2, '0')).join('');
    document.getElementById('secret_key').value = k;

    const pw = document.getElementById('password').value;

    try {
        // ç”Ÿæˆç­¾åå¯†é’¥å¯¹
        const { sk_sig, pk_sig } = await generateKeyPair(k, pw);

        // ç”ŸæˆåŠ å¯†å¯†é’¥å¯¹ï¼ˆéšæœºç”Ÿæˆï¼‰
        const encKeyPair = ec.genKeyPair();
        const sk_enc = encKeyPair.getPrivate('hex');
        const pk_enc = encKeyPair.getPublic('hex');

        // æ˜¾ç¤ºå¯†é’¥ç»™ç”¨æˆ·
        const infoMessage = [
            "è¯·å¦¥å–„ä¿å­˜ä»¥ä¸‹å¯†é’¥ï¼ˆå»ºè®®æˆªå›¾ä¿å­˜ï¼‰ï¼š",
            `ğŸ”‘ åŠ å¯†å¯†é’¥ k: ${k}`,
            `ğŸ” ç­¾åç§é’¥ sk_sig: ${sk_sig}`,
            `ğŸ”‘ åŠ å¯†å…¬é’¥ pk_enc: ${pk_enc}`,  // æ˜¾ç¤ºåŠ å¯†å…¬é’¥
            "\nç‚¹å‡»ç¡®å®šç»§ç»­æ³¨å†Œ"
        ].join('\n\n');

        const saveConfirmed = confirm(infoMessage);
        if (!saveConfirmed) return;

        // è®¾ç½®å¯†é’¥åˆ°éšè—å­—æ®µ
        document.getElementById('pk_sig').value = pk_sig;
        document.getElementById('sk_enc').value = sk_enc;
        document.getElementById('pk_enc').value = pk_enc;

        // æäº¤è¡¨å•
        e.target.submit();
    } catch (error) {
        console.error('æ³¨å†Œå¤±è´¥:', error);
        alert('æ³¨å†Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°');
    }
});
</script>
{% endblock %}