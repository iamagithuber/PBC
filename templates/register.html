{% extends "base.html" %}
{% block title %}ç”¨æˆ·æ³¨å†Œ{% endblock %}
<link rel="stylesheet" type="text/css" href="style.css">
{% block content %}
<div class="auth-card">
    <div class="auth-header">
        <h2>åˆ›å»ºè´¦æˆ·</h2>
        <p class="text-muted">ç«‹å³åŠ å…¥æˆ‘ä»¬</p>
    </div>
    
    <form method="POST" id="registerForm">
        {{ form.hidden_tag() }}
        <div class="mb-3">
            {{ form.username.label(class="form-label") }}
            {{ form.username(class="form-control") }}
        </div>
        <div class="mb-3">
            {{ form.password.label(class="form-label") }}
            {{ form.password(class="form-control", id="password") }}
        </div>
        <div class="mb-3">
            {{ form.confirm_password.label(class="form-label") }}
            {{ form.confirm_password(class="form-control") }}
        </div>
        <input type="hidden" id="pk_sig" name="pk_sig">
        <input type="hidden" id="secret_key" name="secret_key">
        <input type="hidden" id="sk_enc" name="sk_enc">
        <input type="hidden" id="pk_enc" name="pk_enc">

        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary btn-lg">æ³¨å†Œ</button>
        </div>
        <div class="mt-3 text-center">
            <span class="text-muted">å·²æœ‰è´¦å·ï¼Ÿ</span>
            <a href="{{ url_for('login') }}" class="text-decoration-none">ç«‹å³ç™»å½•</a>
        </div>
    </form>
</div>

<!-- å¯†é’¥å±•ç¤ºæ¨¡æ€æ¡† -->
<div id="keyModal" class="modal">
    <div class="modal-content">
        <h3 class="modal-title">ğŸ”’ é‡è¦ï¼è¯·ä¿å­˜æ‚¨çš„å¯†é’¥</h3>
        <div class="key-container">
            <div class="key-item">
                <div class="key-header">
                    <span>åŠ å¯†å¯†é’¥ k</span>
                    <button class="copy-btn" data-key="k">
                        <i class="far fa-copy"></i>
                        å¤åˆ¶
                    </button>
                </div>
                <code id="displayK" class="key-value"></code>
            </div>

            <div class="key-item">
                <div class="key-header">
                    <span>ç­¾åç§é’¥ sk_sig</span>
                    <button class="copy-btn" data-key="sk_sig">
                        <i class="far fa-copy"></i>
                        å¤åˆ¶
                    </button>
                </div>
                <code id="displaySkSig" class="key-value"></code>
            </div>

            <div class="key-item">
                <div class="key-header">
                    <span>åŠ å¯†å…¬é’¥ pk_enc</span>
                    <button class="copy-btn" data-key="pk_enc">
                        <i class="far fa-copy"></i>
                        å¤åˆ¶
                    </button>
                </div>
                <code id="displayPkEnc" class="key-value"></code>
            </div>
        </div>
        <div class="modal-footer">
            <button id="confirmBtn" class="btn btn-success">æˆ‘å·²ä¿å­˜å¯†é’¥</button>
            <button id="cancelBtn" class="btn btn-secondary">å–æ¶ˆ</button>
        </div>
    </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/elliptic/6.5.4/elliptic.min.js"></script>
<script>
const ec = new elliptic.ec('secp256k1');
let generatedKeys = {};

// å¤åˆ¶åŠŸèƒ½
document.addEventListener('click', async (e) => {
    if (e.target.closest('.copy-btn')) {
        const btn = e.target.closest('.copy-btn');
        const keyType = btn.dataset.key;
        const value = generatedKeys[keyType];

        try {
            btn.innerHTML = `<div class="loading"></div>`;
            await navigator.clipboard.writeText(value);
            btn.classList.add('copied');
            btn.innerHTML = `<i class="far fa-check"></i> å·²å¤åˆ¶`;
            setTimeout(() => {
                btn.classList.remove('copied');
                btn.innerHTML = `<i class="far fa-copy"></i> å¤åˆ¶`;
            }, 2000);
        } catch (err) {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            btn.innerHTML = `<i class="far fa-times"></i> å¤åˆ¶å¤±è´¥`;
            setTimeout(() => {
                btn.innerHTML = `<i class="far fa-copy"></i> å¤åˆ¶`;
            }, 2000);
        }
    }
});

// å¯†é’¥ç”Ÿæˆé€»è¾‘
async function generateKeys() {
    const kArray = new Uint8Array(32);
    window.crypto.getRandomValues(kArray);
    const k = Array.from(kArray, b => b.toString(16).padStart(2, '0')).join('');
    const pw = document.getElementById('password').value;

    try {
        // ç”Ÿæˆç­¾åå¯†é’¥
        const { sk_sig, pk_sig } = await (async () => {
            const r = await deriveR(k, pw);
            const rHex = Array.from(r).map(b => b.toString(16).padStart(2, '0')).join('');
            const privKey = toValidPrivateKey(rHex);
            const keyPair = ec.keyFromPrivate(privKey, 'hex');
            return { sk_sig: privKey, pk_sig: keyPair.getPublic('hex') };
        })();

        // ç”ŸæˆåŠ å¯†å¯†é’¥
        const encKeyPair = ec.genKeyPair();
        const pk_enc = encKeyPair.getPublic('hex');

        return { k, sk_sig, pk_sig, pk_enc };
    } catch (error) {
        console.error('å¯†é’¥ç”Ÿæˆå¤±è´¥:', error);
        throw error;
    }
}

async function deriveR(k, pw) {
    const encoder = new TextEncoder();
    const keyData = encoder.encode(k);
    const messageData = encoder.encode(pw);

    const cryptoKey = await window.crypto.subtle.importKey(
        "raw",
        keyData,
        { name: "HMAC", hash: "SHA-256" },
        false,
        ["sign"]
    );

    const signature = await window.crypto.subtle.sign(
        "HMAC",
        cryptoKey,
        messageData
    );

    return new Uint8Array(signature);
}

function toValidPrivateKey(rHex) {
    const key = ec.keyFromPrivate(rHex, 'hex');
    const bn = key.getPrivate();
    const n = ec.curve.n;
    return bn.toString(16).padStart(64, '0');
}

// è¡¨å•æäº¤å¤„ç†
document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const submitBtn = e.target.querySelector('button[type="submit"]');

    try {
        submitBtn.innerHTML = `<div class="loading"></div> æ­£åœ¨ç”Ÿæˆå¯†é’¥...`;
        const keys = await generateKeys();

        generatedKeys = {
            k: keys.k,
            sk_sig: keys.sk_sig,
            pk_enc: keys.pk_enc
        };

        // æ›´æ–°æ˜¾ç¤º
        document.getElementById('displayK').textContent = keys.k;
        document.getElementById('displaySkSig').textContent = keys.sk_sig;
        document.getElementById('displayPkEnc').textContent = keys.pk_enc;
        document.getElementById('keyModal').style.display = 'flex';

        // è®¾ç½®éšè—å­—æ®µ
        document.getElementById('pk_sig').value = keys.pk_sig;
        document.getElementById('secret_key').value = keys.k;
        document.getElementById('sk_enc').value = keys.sk_enc;
        document.getElementById('pk_enc').value = keys.pk_enc;

    } catch (error) {
        alert('å¯†é’¥ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
        console.error(error);
    } finally {
        submitBtn.innerHTML = `æ³¨å†Œ`;
    }
});

// æ¨¡æ€æ¡†æ§åˆ¶
document.getElementById('confirmBtn').addEventListener('click', () => {
    document.getElementById('keyModal').style.display = 'none';
    document.getElementById('registerForm').submit();
});

document.getElementById('cancelBtn').addEventListener('click', () => {
    document.getElementById('keyModal').style.display = 'none';
    generatedKeys = {};
});
</script>

<!-- Font Awesome å›¾æ ‡ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

{% endblock %}